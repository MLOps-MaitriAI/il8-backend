name: Merge Staging to Production (FastAPI Backend, Excluding .github)

on:
  push:
    branches:
      - staging

jobs:
  test_and_build_backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.12'  # Update to match the version in your environment
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          # Add your test command here, for example:
          # python -m pytest tests/
          echo "Running tests... (Add your test command)"

      - name: Lint with pylint  # Alternative linting step
        run: |
          pip install pylint
          pylint auth/user_rights_middleware.py --disable=C0114,C0115,C0116
      
      - name: Fix linting errors (manual and automatic)
        run: |
          # Install autopep8 for auto-fixing issues
          pip install autopep8
          
          # Auto-fix what can be fixed
          autopep8 --in-place --aggressive --aggressive auth/user_rights_middleware.py
          
          # Manually fix remaining issues in user_rights_middleware.py
          sed -i 's/mod\.get_modules_id/get_modules_id/g' auth/user_rights_middleware.py
          sed -i 's/from fastapi import/from fastapi import Rights, /g' auth/user_rights_middleware.py
          
          # Run pylint again to check if errors are resolved
          pylint auth/user_rights_middleware.py --disable=C0114,C0115,C0116

  create_pull_request:
    needs: test_and_build_backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      
      - name: Create temporary branch without .github folder
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git checkout -b temp-staging-branch staging
          git rm -r --cached .github
          git add .
          git commit -m "Remove .github folder and fix linting issues"
      
      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.IL8_CI_CD }}
        run: |
          pr_url=$(gh pr create --base production --head temp-staging-branch --title "Merge Staging to Production (FastAPI Backend, Excluding .github)" --body "This PR merges the latest changes from the staging branch into the production branch for the FastAPI backend, excluding the .github folder and fixing linting issues. Please review and approve to proceed with the merge.")
          echo "PR_URL=$pr_url" >> $GITHUB_ENV
      
      - name: Output PR URL
        run: echo "Pull request created - ${{ env.PR_URL }}"

  merge_pull_request:
    needs: create_pull_request
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      
      - name: Wait for PR Approval
        id: approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.IL8_CI_CD }}
          approvers: MLOps-MaitriAI
      
      - name: Merge Pull Request
        if: steps.approval.outputs.approved == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.IL8_CI_CD }}
        run: |
          pr_number=$(echo ${{ env.PR_URL }} | awk -F'/' '{print $NF}')
          gh pr merge $pr_number --merge
      
      - name: Cleanup temporary branch
        if: steps.approval.outputs.approved == 'true'
        run: |
          git push origin --delete temp-staging-branch
